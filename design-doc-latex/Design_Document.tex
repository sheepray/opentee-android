% For easier proof-reading, use the single-column, double-spaced layout:
\documentclass{cseminar}
% Final Paper use double-column, normal line spacing. Comment the line above and uncomment the following for the full paper
%\documentclass[cameraready]{cseminar}

\usepackage[breaklinks]{hyperref}
\usepackage[hyphenbreaks]{breakurl}
\usepackage{listings}
\usepackage{color}

\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{gray}{rgb}{0.5,0.5,0.5}
\definecolor{mauve}{rgb}{0.58,0,0.82}

\lstset{frame=tbrl,
  language=Java,
  aboveskip=3mm,
  belowskip=3mm,
  showstringspaces=false,
  columns=flexible,
  basicstyle={\small\ttfamily},
  numbers=none,
  numberstyle=\tiny\color{gray},
  keywordstyle=\color{blue},
  commentstyle=\color{dkgreen},
  stringstyle=\color{mauve},
  breaklines=false,
  breakatwhitespace=false,
  tabsize=3
}

\begin{document}

%=========================================================

\title{Design Document: Java API for Trusted Application}

\author{RUI YANG \\
	\texttt{rui.yang@aalto.fi}}
\maketitle

%==========================================================

\begin{abstract}
Based on GlobalPlatform specification, Open-TEE paved a way for normal application developers to develop and deploy GP-compiant Trusted Applications (TA) in Trust Execution Environment (TEE). However, in order to develop a Client Application (CA) (especially Android application), there still lacks an efficient way of exposing the underlining C-based APIs to the application layer which is written in Java. In this design document, this problem will be adderssed in more details and the possibility to wrap the C APIs into Java APIs is discussed.
\vspace{3mm}\\
\noindent KEYWORDS: Open-TEE, Java API, JNI
\end{abstract}

%============================================================
\section{Problem Description}
Open-TEE is a virtual TEE which is based on GlobalPlatform (GP) TEE specifications. It can run on a mobile device on which without real GP-Compliant TEE hardwares. If the mobile device is equipped with GP-Compliant TEE hardware, via one module of Open-TEE called "libtee" \url{https://github.com/Open-TEE/libtee} with corrsponding lower layer linux driver \url{https://github.com/Open-TEE/tee-engine-Driver}, Open-TEE can allow the communications between CAs in Rich Execution Environment (REE) and TAs in the real TEE.\\

If the mobile device does not have a real GP-Compliant TEE hardware, Open-TEE can run as an application in REE itself, which does not provide the security features of a TEE. TAs can be deployed in Open-TEE and the communications between CAs and TAs are provided.\\

The corresponding GP specifications are written in C as such Open-TEE is implemented in C programming language. The problems are list as follows which will occur once Android application developers start using Open-TEE.

\subsection{Problem With C Level API}
The first problem is how to use the C APIs in the application layer. Java Native Interface (JNI) provides the ways to allow the communications between C and Java. So a middle layer between the application layer and C API layer should be provided to reduce the redundant works of application developers.

\subsection{Problem With Shared Memory}
As stated above, the GP TEE specifications only focus on C. There is one notion called "Shared Memory" which is utilized in the specification to avoid big string of memory copies between the CA and TA if they wants to communicate with each other. In C programming language, sharing memory between two processes can be achieved by declaring that these two processes want to share part of their memory. However, since the CA in our scenario is written in Java which does not have the notions of referencing to the memory address in run time environment, which makes the notion of "Shared Memory" hard to implement.

\subsection{Problem With Transferring Big String of Data}
Moreover, since the architecture of Open-TEE for android has been changed in a way that the Open-TEE will run in a seperate android application which running as a service, there is a problem with transferring big string of data from one user application to our Open-TEE CA. For instance, the user application wants to transfer a big file to the TA via CA in Open-TEE to encrypt or decrpt.

\iffalse
\begin{figure}[t]
  \begin{center}
    % Note how the file extension has been removed from the filename below
    % so that the LaTeX command can automatically pick any supported file format
    \includegraphics[width=\textwidth]{figures/draft.JPG}
    \caption{Draft for reminder}
    \label{fig:architec}
  \end{center}
\end{figure}
\fi

%============================================================
\section{Possible Solutions}
Android Shared Memory: Ashmem
How to use \url{http://stackoverflow.com/questions/16099904/how-to-use-shared-memory-ipc-in-android} and \url{http://notjustburritos.tumblr.com/post/21442138796/an-introduction-to-android-shared-memory}

Currently there are two ways to solve the problem No.3. The first solution is to create a shared memory between the user application and CA. So we are trying to share the MemoryFile FD between two different applications. The second solution is to create a parcable object.

\section{Data Type}
All the constants specified in GlobalPlatform TEE Client API specification are the same in this report. Note for the following three symbols:

\begin{enumerate}
	\item[] - indicates private
	\item[] + indicates public
	\item[] \# indicates protected
\end{enumerate}
The following list defines the extra data types.
\begin{enumerate}
	\item TEEC\_Result
			\\C
			\begin{lstlisting}
			typedef uint32_t TEEC_Result;
			\end{lstlisting}
	
			Java
			\begin{lstlisting}
			+ class TEEC_Result{
				- int result;
				
				+ TEEC_Result(int result){
					this.result = result;						
				}
				+ int get_result(void){
					return this.result;						
				}
			}
			\end{lstlisting}
			
	\item <Implementation-Defined Type>
			\\C
			\begin{lstlisting}
			<Implementation-Defined Type> imp;
			\end{lstlisting}
	
			Java
			\begin{lstlisting}
			+ class TEEC_IMP{
				- List<TEEC_IMP> imps;
				- String name;
				
				+ TEEC_IMP(){
					this.imps = new	ArrayList<TEEC_IMP>();
				}
				+ void add_imp(TEEC_IMP imp){
					this.imps.add(imp);						
				}
				+ void set_name(String name){
					this.name = name;				
				}
				+ String get_name(void){
					return this.name;				
				}
			}
			\end{lstlisting}
			
	\item TEEC\_SharedMemory
			\\C
			\begin{lstlisting}
			typedef struct
			{
				void* buffer;
				size_t size;
				uint32_t flags;
				<Implementation-Defined Type> imp;
			}TEEC_SharedMemory;
			\end{lstlisting}
			
			Java
			\begin{lstlisting}
			+ class TEEC_SharedMemory{
				- Byte[] buffer;
				- int flags;
				- TEEC_IMP imp;
				
				+ TEEC_SharedMemory(
								Byte[] buffer,
								int flags,
								TEEC_IMP imp){
					this.buffer = Arrays.copyOf(buffer, buffer.length());
					this.flags = flags;
					this.imp = imp;
				}
				+ Byte[] get_buffer(){
					return this.buffer;				
				}				
				+ int get_flags(){
					return this.flags;				
				}
				+ TEEC_IMP get_imp(){
					return this.imp;				
				}
				
			}
			\end{lstlisting}
			
	
	\item TEEC\_Result\_Union
			\\Java
			\begin{lstlisting}
			+ class TEEC_Result_Union{
				- TEEC_Result result;
				- int payload;
				
				+ TEEC_Result_Union(
								TEEC_Result result,
								int payload){
					this.result = result;
					this.payload = payload;				
				}
				+ TEEC_Result get_result(){
					return this.result; 				
				}
				+ int get_payload(){
					return this.payload;				
				}
			}
			\end{lstlisting}
	
	\item TEEC\_UUID
			\\C
			\begin{lstlisting}
			typedef struct{
				uint32_t timeLow;
				uint16_t timeMid;
				uint16_t timeHiAndVersion;
				uint8_t clockSeqAndNode[8];			
			}TEEC_UUID;
			\end{lstlisting}
			
			Java
			\begin{lstlisting}
			+ class TEEC_UUID{
				- int timeLow;
				- int timeMid;
				- int timeHiAndVersion;
				- int[] clockSeqAndNode;
				
				+ TEEC_UUID(
							int l,
							int m,
							int h,
							int[] c){
					this.timeLow = l;
					this.timeMid = m;
					timeHiAndVersion = h;
					
					if ( c.length == 8 ) this.clockSeqAndNode = Array.copyOf(c, 8);				
				}
				
				+ int get_timeLow(){
					return this.timeLow;				
				}			
				+ int get_timeMid(){
					return this.timeMid;				
				}
				+ int get_timeHiAndVersion(){
					return this.timeHiAndVersion;				
				}
				+ int[] get_clockSeqAndNode(){
					return this.clockSeqAndNode;				
				}
			}
			\end{lstlisting}
	\item TEEC\_Operation
			\\C
			\begin{lstlisting}
			typedef struct{
				uint32_t started;
				uint32_t paramTypes;
				TEEC_Parameter params[4];
				<Implementation-Defined Type> img;
			}TEEC_Operation;
			\end{lstlisting}
			
			Java
			\begin{lstlisting}
			+ class TEEC_Operation{
				- int started = 0;
				- int paramTypes;
				- TEEC_Parameter[] params;
				- TEEC_IMP imp;
				
				+ TEEC_Operation(
								int s,
								int p,
								TEEC_Parameter[] params,
								TEEC_IMP imp){
					this.started = s;
					this.paramTypes = p;
					this.imp = imp;
										
					if (params.length == 4) this.params = Array.copyOf(params, 4);				
				}
				+ int get_started(){
					return this.started;				
				}			
				+ int get_paramTypes(){
					return this.paraTypes;				
				}
				+ TEEC_Parameter[] get_params(){
					return this.params;				
				}
				+ TEEC_IMP get_imp(){
					return this.imp;				
				}
			}
			\end{lstlisting}
			
	\item TEEC\_Parameter
			\\C
			\begin{lstlisting}
			typedef union
			{
				TEEC_TempMemoryReference tmpref;
				TEEC_RegisteredMemoryReference memref;
				TEEC_Value value;
			}TEEC_Parameter;
			\end{lstlisting}
			
			Java
			\begin{lstlisting}
			+ class TEEC_Parameter extends:
				TEEC_TempMemoryReference
				TEEC_RegisteredMemoryReference
			or	TEEC_Value	
			\end{lstlisting}
	

	\item TEEC\_TempMemoryReference
			\\C
			\begin{lstlisting}
			typedef struct{
				void*  buffer;
				size_t size;			
			}TEEC_TempMemoryReference;
			\end{lstlisting}
			
			Java
			\begin{lstlisting}
			+ class TEEC_TempMemoryReference{
				- Byte[] buffer;
				
				+ TEEC_TempMemoryReference(Byte[] buffer){
					this.buffer = Array.copyOf(buffer, buffer.length);				
				}
				+ Byte[] get_buffer(){
					return this.buffer;				
				}
			}
			\end{lstlisting}	
	
	\item TEEC\_RegisteredMemoryReference
			\\C
			\begin{lstlisting}
			typedef struct{
				TEEC_SharedMemory*	parent;
				size_t			  	size;
				size_t				offset;
			}TEEC_RegisteredMemoryReference;
			\end{lstlisting}
	
			Java
			\begin{lstlisting}
			+ class TEEC_RegisteredMemoryReference{
				- TEEC_SharedMemory parent;
				- int				size;
				- int				offset;
				
				+ TEEC_RegisteredMemoryReference(
								TEEC_SharedMemory parent,
								int size,
								int offset){
					this.parent = parent;
					this.size 	= size;
					this.offset = offset;				
				}
				+ TEEC_SharedMemory get_parent(){
					return this.parent;				
				}
				+ int get_size(){
					return this.size;				
				}
				+ int get_offset(){
					return this.offset;				
				}
			}
			\end{lstlisting}
	
	\item TEEC\_Value
			\\C
			\begin{lstlisting}
			typedef struct{
				uint32_t a;
				uint32_t b;
			}TEEC_Value;
			\end{lstlisting}
			
			Java
			\begin{lstlisting}
			+ class TEEC_Value{
				- int a;
				- int b;
				
				+ TEEC_Value(
							int a,
							int b){
					this.a = a;
					this.b = b;							
				}
				+ int get_a(){
					return this.a;				
				}
				+ int get_b(){
					return this.b;				
				}
			}
			\end{lstlisting}
			
	\item TEEC\_Context
			\\C
			\begin{lstlisting}
			typedef struct{
				<Implementation-Defined Type> imp;
			}TEEC_Context;
			\end{lstlisting}
			
			Java
			\begin{lstlisting}
			+ class TEEC_Context{
				- int context;
				
				+ TEEC_Context(int context){
					this.context = context;				
				}
				+ int get_context(){
					return this.context;				
				}
			}
			\end{lstlisting}
			
	\item TEEC\_Session
			\\C
			\begin{lstlisting}
			typedef struct{
				<Implementation-Defined Type> imp;
			}TEEC_Session;
			\end{lstlisting}
			
			Java
			\begin{lstlisting}
			+ class TEEC_Session{
				- int session;
				
				+ TEEC_Session(int session){
					this.session = session;				
				}
				+ int get_session(){
					return this.session;				
				}
			}
			\end{lstlisting}
\end{enumerate}



\section{Java APIs corresponding to C APIs}
\begin{enumerate}

%	\item \texttt{int TEEU\_GetAPPID(\\static String name);}

	\item C
			\begin{lstlisting}
			TEEC_RESULT TEEC_InitializeContext(
				const char* name,
				TEEC_Context* context)
			\end{lstlisting}
		  
		  Java
		  	\begin{lstlisting}
		  	TEEC_RESULT_UNION TEEC_InitializeContext(
				static const string name,
				TEEC_Context context)	/** context passed in should be the ID 
				* of the TA it wants to initialize and the output value
				* should be an int value regarded as context for later usage;
				**/
			\end{lstlisting}


	\item C
			\begin{lstlisting}
			void TEEC_FinalizeContext(
				TEEC_Context* context)
			\end{lstlisting}
		  
		  Java
		  	\begin{lstlisting}
		  	void TEEC_FinalizeContext(
				TEEC_Context context)
			\end{lstlisting}


	\item C
			\begin{lstlisting}
			TEEC_RESULT TEEC_RegisterSharedMemory(
				TEEC_Context* context,
				TEEC_SharedMemory sharedMem)
			\end{lstlisting}
		  
		  Java
		  	\begin{lstlisting}
		  	TEEC_RESULT TEEC_RegisterSharedMemory(
				TEEC_Context context,
				TEEC_SharedMemory sharedMem)
			\end{lstlisting}


	\item C
			\begin{lstlisting}
			TEEC_RESULT TEEC_AllocateSharedMemory(
				TEEC_Context* context,
				TEEC_SharedMemory sharedMem)
			\end{lstlisting}
		  
		  Java
		  	\begin{lstlisting}
		  	TEEC_RESULT TEEC_AllocateSharedMemory(
				TEEC_Context context,
				TEEC_SharedMemory sharedMem)
			\end{lstlisting}


	\item C
			\begin{lstlisting}
			void TEE_ReleaseSharedMemory(
				TEEC_Context* contxt,
				TEEC_SharedMemory sharedMem)
			\end{lstlisting}
		  
		  Java
		  	\begin{lstlisting}
		  	void TEE_ReleaseSharedMemory(
				TEEC_Context context,
				TEEC_SharedMemory sharedMem)
			\end{lstlisting}


	\item C
			\begin{lstlisting}
			TEEC_RESULT TEEC_OpenSession(
				TEEC_Context* context,
				TEEC_Session* session;
				const TEEC_UUID* destination,
				uint32_t connectionMethod,
				const void* connectionData,
				TEEC_Operation* operation,
				uint32_t* returnOrigin)
			\end{lstlisting}
		  
		  Java
		  	\begin{lstlisting}
		  	TEEC_RESULT TEEC_OpenSession(
				TEEC_Context context,
				TEEC_Session session;
				const TEEC_UUID destination,
				int connectionMethod,
				Byte[] connectionData,
				TEEC_Operation operation,
				Integer returnOrigin)
			\end{lstlisting}


	\item C
			\begin{lstlisting}
			void TEEC_CloseSession(
				TEEC_Session* session)
			\end{lstlisting}
		  
		  Java
		  	\begin{lstlisting}
		  	void TEEC_CloseSession(
				TEEC_Session session)
			\end{lstlisting}



	\item C
			\begin{lstlisting}
			TEEC_RESULT TEEC_InvokeCommand(
				TEEC_Session* session,
				uint32_t command_ID,
				TEEC_OPERATION* operation,
				uint32_t* returnOrigin)
			\end{lstlisting}
		  
		  Java
		  	\begin{lstlisting}
		  	TEEC_RESULT TEEC_InvokeCommand(
				TEEC_Session session,
				int command_ID,
				TEEC_OPERATION operation,
				Integer returnOrigin)
			\end{lstlisting}

			
	\item C
			\begin{lstlisting}
			void TEEC_RequestCancellation(
				TEEC_OPERATION* operation)
			\end{lstlisting}
		  
		  Java
		  	\begin{lstlisting}
		  	void TEEC_RequestCancellation(
				TEEC_OPERATION operation)
			\end{lstlisting}

\end{enumerate}


%============================================================
\iffalse

\section{Simple things first}

In this section, we give some simple examples of Latex mark-up.
Sec.~\ref{sec:emphasis} emphasizes important points and
Sec.~\ref{sec:math} gives examples of math formulas.
Finally, \ref{sec:list} demonstrates lists.


%------------------------------------------------------------


\subsection{Emphasizing text}
\label{sec:emphasis}

\textit{Italics} is a good way to emphasize printed text. However,
\textbf{boldface} looks better when converted to HTML.

Paragraphs are separated by an empty line in the Latex source code.
Latex puts extra space between sentences, which you must suppress
after a period that does not end a sentence, e.g.\ after this acronym.

Cross-references to figures (Fig.~\ref{fig:mypicture1}), tables
(Table~\ref{tab:mytable1}), other sections (Sec.~\ref{sec:math})
are easy to create. 


%------------------------------------------------------------


\subsection{Mathematics}
\label{sec:math}

In the mathematics mode, you can have subscripts such as $K_{master}$
and superscripts like $2^x$. Longer formulas may be put on a separate
line:
\[ \emptyset \in \emptyset \; \Rightarrow \; E \neq mc^2. \]

You may also want to number the formulas like Eq.~(\ref{eqn:myequation1})
below.
\begin{equation}\label{eqn:myequation1}
C = E_{K_{public}}(P) = P^e. \hspace{10mm}   P = D_{K_{private}}(C) = C^d.
\end{equation}



%------------------------------------------------------------


\subsection{Make a list}
\label{sec:list}

Lists can have either bullets or numbers on them. 

\begin{itemize}
\item one item
\item another item, which is an exceptionally long one for an item
  and consequently continues on the next line.
\end{itemize}

Lists can have several levels. Item~\ref{kukkuu} below contains
another list.
\begin{enumerate}
\item the fist item \label{kukkuu}
  \begin{enumerate}
  \item the first subitem 
  \item the second subitem
  \end{enumerate}
\item the second item
\end{enumerate}


%============================================================


\section{More complex stuff}

This section provides examples of more complex things.


%------------------------------------------------------------


\subsection{Data served on a table}


Table~\ref{tab:mytable1} presents some data in tabular form. 

\begin{table}[t]
  \begin{center}
    \begin{tabular}{|l|lr|}
    \hline
    Protocol & Year &  RFC \\
    \hline
    TCP      & 1981 &  793 \\
    ISAKMP   & 1998 & 2408 \\
    Photuris & 1999 & 2522 \\
    \hline
    \end{tabular}
    \caption{A table with some protocols}
    \label{tab:mytable1}
  \end{center}
\end{table}


%------------------------------------------------------------


\subsection{Adding references}
\label{sec:references}

Do not forget to give pointers to the literature. If you are listing
stuff related to your topic, you can give several references once
\cite{Com00,HTS03,Nik99}. However, usually you should give only one, for example the standard describing the stuff \cite{RFC2408} and if you want to directly use someone else's words, use both quotation marks and refer to the source, for example that ``the developer does not need to know all about the framework to develop a working implementation'' \cite{Suo98}. Remember also to mark references to your pictures if they are not created by your own mind!

If you plan to write with Latex regularly, create your own BibTeX
database and use BibTeX to typeset the bibliographies automatically.
In the long run, it will save you a lot of time and effort compared to
compiling reference lists by hand.


%------------------------------------------------------------


\subsection{Embedded pictures}
\label{sec:pictures}

Fig.~\ref{fig:mypicture1} is an embedded picture. The supported formats for pictures
depend on the actual LaTeX command used. For instance, regular \LaTeX supports
pictures in EPS (Embedded PostScript) format, while pdf\LaTeX supports PDF (Portable
Document Format), PNG (Portable Network Graphics) and JPEG (Joint Photographic Experts
Group). It is recommended to use either EPS or PDF for diagrams as well as for any picture
which includes vector images.

\begin{figure}[t]
  \begin{center}
    % Note how the file extension has been removed from the filename below
    % so that the LaTeX command can automatically pick any supported file format
    \includegraphics[width=.5\textwidth]{figures/sample}
    \caption{An embedded picture}
    \label{fig:mypicture1}
  \end{center}
\end{figure}


%============================================================


\section{Yet another section title}


%============================================================


\section{Conclusion}
This is conclusion.

%============================================================

% List of references is created with bibtex.


\fi
\bibliography{seminar-paper}
\end{document}
